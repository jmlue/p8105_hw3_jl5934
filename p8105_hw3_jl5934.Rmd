---
title: "p8105_hw3_jl5934"
author: "Jesus Luevano"
date: "2023-10-06"
output: github_document
---

```{r loading}
library(tidyverse)
library(p8105.datasets)
data("instacart")
data("brfss_smart2010")
```

# Problem 1

## Describing the dataset

* There are `r nrow(instacart)` rows and `r ncol(instacart)` columns in the `instacart` dataframe.

* The variables included are `r names(instacart)`.  


* There are `r length(unique(instacart[["aisle_id"]]))` aisles in the dataframe. 

```{r rank aisles}
instacart %>%
  group_by(aisle_id) %>%
  summarize(n_obs = n())
```
 
 * The top 3 aisles from where purchases are ordered from are Aisle 83 (150609 purchases), 24 (150473 purchases), and 123 (78493 purchases).
 
```{r plot aisles}
instacart %>%
  group_by(aisle_id) %>%
  summarize(n_obs = n()) %>%
  filter(n_obs > 10000) %>%
  arrange(desc(n_obs)) %>%
  ggplot(aes(x = aisle_id, y = n_obs)) +
  geom_point() +
  xlab("Aisle ID") + ylab("Observations")
```
 
```{r}
a <- instacart %>%
  filter(aisle == c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>% #filter(aisle == "baking ingredients" | aisle == "dog food care" | aisle == "packaged vegetables fruits")
  group_by(aisle, product_name) %>%
  summarize(n_obs = n()) %>%  #count(product_name = "n_obs")
  arrange(desc(n_obs)) %>%
  slice_max(order_by = n_obs, n = 3) %>%
  knitr::kable()
```
 
```{r}
instacart %>%
  filter(product_name == c("Pink Lady Apples", "Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>%
  summarize(Mean = mean(order_hour_of_day, na.rm = TRUE)) %>%
  pivot_wider(
    names_from = order_dow,
    values_from = Mean
  ) %>%
knitr::kable()
```
 
 
# Problem 2

```{r set up BRFSS dataframe}
BRFSS <- brfss_smart2010 %>%
  janitor::clean_names() %>%
  filter(topic == "Overall Health") %>%
  mutate(response = response %>%
           fct_recode("Poor" = "Poor", "Fair" = "Fair", "Good" = "Good", "Very good" = "Very good", "Excellent" = "Excellent")) 
```

```{r states with 7+ observations, 2002}
BRFSS %>%
  filter(year == 2002) %>%
  distinct(locationabbr, year, locationdesc) %>%
  group_by(locationabbr) %>%
  summarize(n_obs = n()) %>%
  filter(n_obs >= 7) %>%
  knitr::kable()
```

There are 7 states with more than 7 observations in 2002.

```{r states with 7+ observations, 2010}
BRFSS %>%
  filter(year == 2010) %>%
  distinct(locationabbr, year, locationdesc) %>%
  group_by(locationabbr) %>%
  summarize(n_obs = n()) %>%
  filter(n_obs >= 7) %>%
  knitr::kable()
```

There are 14 states with ore than 7 observations in 2010.

```{r average state excellent}
BRFSS %>%
  janitor::clean_names() %>%
  filter(response == "Excellent") %>%
  group_by(locationabbr, year) %>% 
  mutate(mean_DV = mean(data_value)) %>%
  select(year, locationabbr, mean_DV) %>% #locastiondesc
  ggplot(aes(x = year, y = mean_DV)) + 
  geom_line(aes(group = locationabbr)) + 
  geom_smooth()
  labs(x = "Year", y = "Mean Data Value", title = "Plot of mean value by year for each state", locationabbr = "State Abbreviation")  

```

When plotting the mean values of `data_value` for the multiple locations of a state, by year we are able to create a sphagetti plot showing the changes from 2002-2010.


```{r data values for NY across years}
brfss_smart2010 %>%
  janitor::clean_names() %>%
  filter(year == c("2006", "2010"), locationabbr == "NY", topic == "Overall Health") %>%
  group_by(response, locationdesc) %>%
  mutate(mean_DV = mean(data_value)) %>%
  ggplot(aes(x= locationdesc, y = mean_DV, color = response)) + 
  geom_bar(stat = "identity") +
  labs(x = "Response Level", y = "Mean Data Value", title = "Mean data Values per response of NY counties in 2006 and 2010", locationdesc = "NY County") +
  facet_grid(rows = vars(year))
    
```

We have plotted the mean `data_value` for each location within NY (Bronx County, Erie County, Kings County, Monroe County, Nassau County, New York County, Queens County, Suffolk County, & Westchester County) for the years 2006 and 2010 separately.

# Problem 3

We will import the dataframes from NHANES for the acceleratomer data `accel.df` and demographic data `covar.df`. We will filter out subhects from the demographic dataframe `covar.df` based on age (remove those less than 21 years), remove those with missing demographic data, and recode `education` and `sex` as appropriate factors. 

We will then combine them by `inner_join` to select out only subjects who met the inclusion criteria from the filters placed on `covar.df`. 

```{r import and prep NHANES}
accel.df <- read_csv("p8105_hw3_jl5934_files/data/nhanes_accel.csv") %>%
  janitor::clean_names()

covar.df <- read_csv("p8105_hw3_jl5934_files/data/nhanes_covar.csv",
                     skip = 4) %>%
  janitor::clean_names() %>%
  filter(age > 21) %>%
  na.omit() %>%
  mutate(education = as.factor(education) %>%
           fct_recode("Less_than_HS" = "1", "HS_equivalent" = "2", "More_than_HS" = "3")) %>%
  mutate(sex = as.factor(sex) %>% 
           fct_recode("male" = "1", "female" = "2"))

accel_covar.df <- inner_join(covar.df, accel.df, by = "seqn")

```

Producing a table for count of men and women in each education category.

```{r table count}
accel_covar.df %>%
  group_by(sex, education) %>%
  summarize(n_obs = n())
```

* For both Males and Females, the majority had education that was more than high school equivalent. However in second rank for males was high school equivalent and last less then high school; whereas for females it was less than high school in second rank then high school equivalent in last rank.


Making plot of age distribution by education level and sex.

```{r plot for table count by sex/education}
accel_covar.df %>%
  group_by(sex, education) %>%
  ggplot(aes(x = age, color = education)) +
  geom_boxplot() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  labs(x = "Age in Years", title = "Age distribution of education levels by sex") +
  facet_grid(rows = vars(sex))
```


Next we will make a plot that creates a new variable `Total_activity` that is the aggregate of the total accelerometer readings for the 24-hour period for an individual. 

```{r Total activity plot}
accel_covar.df %>%
  mutate(Total_activity = rowSums(.[6:1445])) %>%
  ggplot(aes(x = age, y = Total_activity, color = sex)) +
  geom_point() + 
  geom_smooth(se= FALSE) +
  labs(x = "Age in years", y = "Total Activity", title = "Total activity by age, education, and sex") +
  facet_grid(rows = vars(education))
```

* This plot demonstrates that across all education levels and both genders, the total activity level decreases with age. 

  * For lower education levels there is a trend towards higher overall levels of total activity until about age 60 where they all have a decrease. 

  * In addition, females tend to have lower total activity levels across all education levels at younger ages, but this flips around 50 years for those with less than high school education.

```{r 24-insepction by eduation and sex, echo = FALSE}
accel_covar.df %>%
  pivot_longer(min1:min1440,
    names_to = "Minute", values_to = "activity") %>%
  ggplot(aes(x = Minute, y = activity, color= sex)) +
  geom_point() +
  geom_smooth(aes(color = seqn), se = FALSE) + 
  labs(x = "Minutes", y  = "Activity", title = "24hr activity time course by education level and sex") +
  scale_x_discrete(
    breaks = c(0, 240, 480, 720, 960, 1200, 1440, 1680, 1920, 2160, 2400),
    labels = c("0", "240", "480", "720", "960", "1200", "1440", "1680", "1920", "2160", "2400")
  ) +
  facet_grid(rows = vars(education))

accel_covar.df %>%
  pivot_longer(min1:min1440,
    names_to = "minute", values_to = "activity") %>%
  group_by(minute, sex, education) %>%
  summarize(mean_minute_value = mean(activity)) %>%
  #mutate(minute_mean = mean(minute)) %>%
  ggplot(aes(x = minute, y = mean_minute_value, color= sex)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  facet_grid(rows = vars(education))
```

